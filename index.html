<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Aesthetic Quotes — Pro (with upload & share)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --glass: rgba(255,255,255,0.10);
    --accent: rgba(255,255,255,0.95);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family:"Cairo", system-ui, sans-serif;
    background: linear-gradient(135deg,#0f172a 0%, #1f2a44 100%);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    color:var(--accent);
  }

  .app {
    width:100%;
    max-width:1100px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    padding:16px;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    position:relative;
    overflow:hidden;
  }

  .canvas-wrap{
    position:relative;
    width:100%;
    aspect-ratio:16/9;
    border-radius:10px;
    overflow:hidden;
    background:#111;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .bg-layer{
    position:absolute; inset:0;
    background-size:cover;
    background-position:center;
    filter:brightness(0.78) saturate(1.05);
    transform-origin:center;
    transition:opacity 900ms ease, transform 900ms ease, filter 600ms ease;
  }

  .overlay { position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.45)); pointer-events:none; z-index:3; }

  /* cinematic effects layers */
  .vignette { position:absolute; inset:0; pointer-events:none; z-index:8; mix-blend-mode:multiply; opacity:0.6; background: radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.65) 100%); display:none; }
  .grain { position:absolute; inset:0; pointer-events:none; z-index:9; opacity:0.12; background-image: url('data:image/svg+xml;utf8,\
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">\
      <filter id="n"><feTurbulence baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter>\
      <rect width="100%" height="100%" filter="url(%23n)" opacity="0.5"/></svg>'); background-size:200% 200%; display:none; mix-blend-mode:overlay; }

  .quote-box{
    position:relative; z-index:5; padding:28px; max-width:90%; text-align:center; color:var(--accent);
    display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; pointer-events:none;
  }
  .quote-text{
    font-family:"Playfair Display", serif;
    font-size:clamp(22px, 3.0vw, 44px);
    line-height:1.08; letter-spacing:0.4px; text-shadow:0 8px 22px rgba(0,0,0,0.5);
    direction:rtl; white-space:pre-wrap; max-width:100%;
  }
  .quote-author{ font-size:14px; opacity:0.9; font-weight:600; }

  .controls{ margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .left-controls, .right-controls{ display:flex; gap:8px; align-items:center; }

  .btn {
    background:var(--glass); border:none; color:var(--accent); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    display:inline-flex; gap:8px; align-items:center; transition:transform .18s ease, background .2s;
  }
  .btn:hover{ transform:translateY(-4px); }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); }
  .small{ padding:8px 10px; font-size:14px; }

  .sidebar { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .input-inline{ display:flex; gap:8px; align-items:center; }
  input[type="text"], textarea, select{ background:rgba(255,255,255,0.05); border:none; color:var(--accent); padding:8px 12px; border-radius:10px; outline:none; }
  input[type="file"]{ color:var(--accent); }

  .chip{ background:rgba(255,255,255,0.04); padding:8px 10px; border-radius:999px; cursor:pointer; }
  .chip.active{ outline:1px solid rgba(255,255,255,0.08); transform:translateY(-4px); }

  .thumbs{ display:flex; gap:8px; overflow:auto; padding:8px 4px; max-width:100%; }
  .thumb{ width:84px; height:48px; border-radius:8px; object-fit:cover; cursor:pointer; border:2px solid transparent; transition:transform .18s; }
  .thumb:hover{ transform:translateY(-6px); }
  .thumb.active{ border-color:rgba(255,255,255,0.28); box-shadow:0 6px 20px rgba(0,0,0,0.5); }

  .note{ font-size:13px; color:rgba(255,255,255,0.78); }

  .dots{ display:flex; gap:8px; align-items:center; }
  .dot{ width:9px; height:9px; border-radius:50%; background:rgba(255,255,255,0.2); }
  .dot.active{ background:var(--accent); transform:scale(1.2); }

  @media (max-width:760px){
    .controls{ gap:8px; }
    .thumb{ width:72px; height:44px; }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="My Aesthetic Quotes Pro">
    <div class="canvas-wrap" id="canvasWrap">
      <div class="bg-layer" id="bg0" style="opacity:1"></div>
      <div class="bg-layer" id="bg1" style="opacity:0; transform:scale(1.05)"></div>
      <div class="overlay"></div>
      <div class="vignette" id="vignette"></div>
      <div class="grain" id="grain"></div>

      <div class="quote-box" id="quoteBox" aria-live="polite">
        <div class="quote-text" id="quoteText">...</div>
        <div class="quote-author" id="quoteAuthor"></div>
      </div>
    </div>

    <div class="controls">
      <div class="left-controls">
        <button class="btn" id="prevBtn">⟸ سابق</button>
        <button class="btn" id="playPauseBtn">⏯️ إيقاف</button>
        <button class="btn" id="nextBtn">التالي ⟹</button>
        <div style="display:flex;align-items:center;gap:6px;padding:6px;background:rgba(255,255,255,0.02);border-radius:8px;">
          <label style="font-size:13px;opacity:0.9">سرعة</label>
          <select id="speedSelect" style="background:transparent;border:none;color:var(--accent);">
            <option value="6000">عادي</option>
            <option value="4000">سريع</option>
            <option value="9000">بطيء</option>
          </select>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;">
        <div class="dots" id="dots"></div>
      </div>

      <div class="right-controls">
        <button class="btn ghost" id="downloadBtn" title="تحميل PNG">⬇️ حفظ PNG</button>
        <button class="btn ghost" id="shareNativeBtn" title="مشاركة (الهاتف)"> مشاركة</button>
        <button class="btn ghost" id="shareTwitterBtn" title="مشاركة على تويتر"> تويتر</button>
        <button class="btn ghost" id="shareInstaBtn" title="مشاركة على انستجرام">انستجرام</button>
        <button class="btn ghost" id="toggleCineBtn" title="تأثيرات سينمائية"> فيلم</button>
      </div>
    </div>

    <div class="sidebar">
      <div class="input-inline" aria-hidden="false">
        <input id="addQuoteInput" type="text" placeholder="اكتب اقتباس جديد..." />
        <input id="addAuthor" type="text" placeholder="المؤلف (اختياري)" style="width:160px" />
        <button class="btn small add-btn" id="addBtn">أضف اقتباس</button>
      </div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div class="chip" id="filterAll">الكل</div>
        <div class="chip" id="filterFav">المفضلات</div>
        <div class="chip" id="filterLong">طويل</div>
        <div class="chip" id="filterShort">قصير</div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div style="display:flex; gap:10px; align-items:center;">
        <label class="note">رفع / إدارة خلفيات:</label>
        <input id="bgUpload" type="file" accept="image/*" />
        <button class="btn small" id="addBgBtn">أضف خلفية</button>
        <button class="btn small ghost" id="clearUserBgBtn" title="حذف كل الخلفيات المرفوعة">🗑️ حذف الكل</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <label class="note">حجم النص</label>
        <input id="fontSize" type="range" min="18" max="56" value="34" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="thumbs" id="thumbs"></div>
    </div>

    <div style="margin-top:8px; display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <div style="color:rgba(255,255,255,0.72); font-size:13px;">نسخة Pro — رفع خلفياتك ومشاركة الصور مباشرة</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:13px;color:rgba(255,255,255,0.75)">أوضاع: </label>
        <span id="cineState" class="note">فيلم: معطل</span>
      </div>
    </div>
  </div>

<script>
/* ======== بيانات افتراضية ======== */
const defaultQuotes = [
  {text: "لا تنتظري الإلهام — اصنعيه.", author: "— أميرة الإصرار"},
  {text: "كل لحظة هي فرصة جديدة لتبدئي من جديد.", author: "— بداية جميلة"},
  {text: "كوني لطيفة مع نفسك، فالتقدم يبدأ بخطوة صغيرة.", author: "— خطوة بسيطة"},
  {text: "القلب الشجاع يجعل من الخوف وقوداً.", author: "— شجاعة"},
  {text: "الحياة قصيرة؛ افعلي ما يُشعركِ بالحياة.", author: "— تذكير"}
];

/* صور خلفية افتراضية (روابط Unsplash) */
let backgrounds = [
  'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=0b04b9b3b7b2b2e4f1a1ee7b1a0b8b00',
  'https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=7f8d3b6d7c6d2a3f0f89d7ccb6b6f055',
  'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=38f9c4a1a6c5bc3b6a8b2b8c5b1b2a7e',
  'https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=8c3a1fc0e2d8d9e3a6b0d3f2a7c4e1a2',
  'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=bb2c4f1b1a1e1b2c3d4e5f6a7b8c9d0e'
];

/* عناصر DOM */
const bg0 = document.getElementById('bg0'), bg1 = document.getElementById('bg1');
const quoteText = document.getElementById('quoteText'), quoteAuthor = document.getElementById('quoteAuthor');
const dotsEl = document.getElementById('dots'), thumbsEl = document.getElementById('thumbs');
const playPauseBtn = document.getElementById('playPauseBtn'), prevBtn = document.getElementById('prevBtn'), nextBtn = document.getElementById('nextBtn');
const downloadBtn = document.getElementById('downloadBtn'), shareNativeBtn = document.getElementById('shareNativeBtn');
const shareTwitterBtn = document.getElementById('shareTwitterBtn'), shareInstaBtn = document.getElementById('shareInstaBtn');
const speedSelect = document.getElementById('speedSelect');
const addBtn = document.getElementById('addBtn'), addQuoteInput = document.getElementById('addQuoteInput'), addAuthor = document.getElementById('addAuthor');
const fontSizeRange = document.getElementById('fontSize');
const bgUpload = document.getElementById('bgUpload'), addBgBtn = document.getElementById('addBgBtn'), clearUserBgBtn = document.getElementById('clearUserBgBtn');
const toggleCineBtn = document.getElementById('toggleCineBtn'), vignetteEl = document.getElementById('vignette'), grainEl = document.getElementById('grain');
const cineState = document.getElementById('cineState');

let currentIndex = 0, isPlaying = true, timer = null, intervalMs = parseInt(speedSelect.value), activeBg = 0;
let favs = JSON.parse(localStorage.getItem('quotes_favs') || "[]");
let userQuotes = JSON.parse(localStorage.getItem('quotes_user') || "[]");
let userBackgrounds = JSON.parse(localStorage.getItem('user_backgrounds') || "[]");
let useCinematic = false;

/* دمج الخلفيات الافتراضية + مرفوعة المستخدم */
function loadBackgrounds(){
  // userBackgrounds (data URLs) توضع أولاً لسهولة الاختيار
  backgrounds = (userBackgrounds.concat(backgrounds));
  renderThumbs();
}

/* render thumbs */
function renderThumbs(){
  thumbsEl.innerHTML = '';
  backgrounds.forEach((url,i)=>{
    const img = document.createElement('img');
    img.src = url;
    img.className = 'thumb' + (i===currentIndex ? ' active' : '');
    img.dataset.i = i;
    img.title = `خلفية ${i+1}`;
    img.addEventListener('click', ()=> { showIndex(currentIndex); setBackground(i); highlightThumb(i); });
    thumbsEl.appendChild(img);
  });
}

/* highlight thumb */
function highlightThumb(i){
  thumbsEl.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));
  const t = thumbsEl.querySelector(`.thumb[data-i="${i}"]`);
  if(t) t.classList.add('active');
}

/* دمج الاقتباسات الأساسية + مضافة المستخدم */
function allQuotes(){
  return defaultQuotes.concat(userQuotes);
}

/* render dots */
function renderDots(){
  dotsEl.innerHTML = '';
  allQuotes().forEach((q,i)=>{
    const d = document.createElement('div');
    d.className = 'dot' + (i===currentIndex?' active':'');
    d.dataset.i = i;
    d.title = `عرض الاقتباس ${i+1}`;
    d.addEventListener('click', ()=> { showIndex(i); });
    dotsEl.appendChild(d);
  });
}

/* set background with crossfade */
function setBackground(index){
  const url = backgrounds[index % backgrounds.length];
  const nextBg = activeBg===0 ? bg1 : bg0;
  nextBg.style.backgroundImage = `url("${url}")`;
  nextBg.style.opacity = 0;
  nextBg.style.transform = 'scale(1.05)';
  void nextBg.offsetWidth;
  nextBg.style.transition = 'opacity 900ms ease, transform 900ms ease';
  nextBg.style.opacity = 1;
  nextBg.style.transform = 'scale(1)';
  const prevBg = activeBg===0 ? bg0 : bg1;
  prevBg.style.opacity = 0;
  prevBg.style.transform = 'scale(1.05)';
  activeBg = activeBg===0 ? 1 : 0;
  highlightThumb(index);
}

/* render quote */
function renderQuote(){
  const q = allQuotes()[currentIndex];
  if(!q) return;
  quoteText.textContent = q.text;
  quoteAuthor.textContent = q.author || '';
  renderDots();
  updateFavButton();
  setBackground(currentIndex);
  const box = document.getElementById('quoteBox');
  box.style.opacity = 0;
  box.style.transform = 'translateY(8px)';
  setTimeout(()=>{ box.style.transition='all 420ms'; box.style.opacity=1; box.style.transform='translateY(0)'; }, 60);
}

/* show index */
function showIndex(i){
  const arr = allQuotes();
  if(arr.length===0) return;
  currentIndex = ((i % arr.length) + arr.length) % arr.length;
  renderQuote();
  restartTimer();
}

/* prev/next */
prevBtn.addEventListener('click', ()=> showIndex(currentIndex - 1));
nextBtn.addEventListener('click', ()=> showIndex(currentIndex + 1));

/* play/pause */
function startTimer(){
  stopTimer();
  if(!isPlaying) return;
  intervalMs = parseInt(speedSelect.value);
  timer = setInterval(()=> { showIndex(currentIndex + 1); }, intervalMs);
  playPauseBtn.textContent = '⏯️ إيقاف';
}
function stopTimer(){ if(timer) clearInterval(timer); timer=null; }
function restartTimer(){ if(isPlaying) startTimer(); }
playPauseBtn.addEventListener('click', ()=>{
  isPlaying = !isPlaying;
  if(isPlaying) startTimer(); else { stopTimer(); playPauseBtn.textContent='⏯️ تشغيل'; }
});
speedSelect.addEventListener('change', ()=> { intervalMs = parseInt(speedSelect.value); restartTimer(); });

/* add quote */
addBtn.addEventListener('click', ()=>{
  const t = addQuoteInput.value.trim(); if(!t) return;
  const a = addAuthor.value.trim();
  userQuotes.push({text:t, author: a ? ("— " + a) : ""});
  localStorage.setItem('quotes_user', JSON.stringify(userQuotes));
  addQuoteInput.value=''; addAuthor.value='';
  showIndex(allQuotes().length -1);
  renderDots();
});

/* favorites handling */
function updateFavButton(){
  const q = allQuotes()[currentIndex];
  const key = JSON.stringify(q);
  const btn = document.getElementById('shareInstaBtn'); // just to ensure loaded; update text of fav location not needed here
}
let favsArr = favs || [];
/* Filters (simple temporary views) */
document.getElementById('filterAll').addEventListener('click', ()=> { resetTempView(); });
document.getElementById('filterFav').addEventListener('click', ()=> {
  if(favsArr.length===0){ alert('لا توجد مفضلات محفوظة بعد. اضغطي زر الحفظ (⭐) أولاً.'); return; }
  renderCustomView(favsArr);
});
document.getElementById('filterLong').addEventListener('click', ()=> {
  const arr = allQuotes().filter(q=> q.text.length > 60);
  if(arr.length===0){ alert('لا توجد اقتباسات طويلة حالياً.'); return; }
  renderCustomView(arr);
});
document.getElementById('filterShort').addEventListener('click', ()=> {
  const arr = allQuotes().filter(q=> q.text.length <= 60);
  if(arr.length===0){ alert('لا توجد اقتباسات قصيرة حالياً.'); return; }
  renderCustomView(arr);
});
function renderCustomView(arr){ dotsEl.innerHTML=''; arr.forEach((q,i)=>{ const d=document.createElement('div'); d.className='dot'+(i===0?' active':''); d.addEventListener('click', ()=>{ quoteText.textContent=q.text; quoteAuthor.textContent=q.author||''; setBackground(i); }); dotsEl.appendChild(d); }); quoteText.textContent=arr[0].text; quoteAuthor.textContent=arr[0].author||''; }

/* download / export to PNG (canvas drawing) */
downloadBtn.addEventListener('click', ()=> downloadCurrentQuoteImage(true));

/* share native (Web Share API with files) */
shareNativeBtn.addEventListener('click', async ()=>{
  try{
    const blob = await drawCanvasBlob();
    // if navigator.share supports files
    if(navigator.canShare && navigator.canShare({files: [new File([blob], 'quote.png', {type:'image/png'})]})){
      await navigator.share({ files: [new File([blob], 'quote.png', {type:'image/png'})], text: allQuotes()[currentIndex].text });
    } else if(navigator.share){
      // fallback: share URL (will share blob as data URL not supported), so download first then offer
      const url = URL.createObjectURL(blob);
      await navigator.share({ title: 'Quote', text: allQuotes()[currentIndex].text, url });
      URL.revokeObjectURL(url);
    } else {
      // no native share -> download then prompt upload manually
      await downloadCurrentQuoteImage(false);
      alert('تم تنزيل الصورة. افتحي تطبيق انستجرام أو تويتر وارفعِي الصورة يدويًا للتشارك.');
    }
  }catch(err){
    console.error(err);
    alert('لم يتم التشارك عبر الجهاز. تم تنزيل الصورة بدلًا من ذلك.');
    await downloadCurrentQuoteImage(false);
  }
});

/* share to Twitter (opens tweet composer with text; user can upload image manually) */
shareTwitterBtn.addEventListener('click', async ()=>{
  const q = allQuotes()[currentIndex];
  const text = encodeURIComponent(q.text + (q.author? ' ' + q.author : '') + ' — My Aesthetic Quotes');
  const url = `https://twitter.com/intent/tweet?text=${text}`;
  window.open(url, '_blank');
});

/* share to Instagram: try native share, else download and instruct */
shareInstaBtn.addEventListener('click', async ()=>{
  try{
    const blob = await drawCanvasBlob();
    if(navigator.canShare && navigator.canShare({files: [new File([blob], 'quote.png', {type:'image/png'})]})){
      await navigator.share({ files: [new File([blob], 'quote.png', {type:'image/png'})], title: allQuotes()[currentIndex].text });
    } else {
      await downloadCurrentQuoteImage(false);
      alert('تم تنزيل الصورة. افتحي تطبيق انستجرام وارفعِي الصورة يدويًا. (متصفحات الويب لا تسمح دائماً بالرفع المباشر إلى انستجرام)');
    }
  }catch(e){
    console.error(e);
    await downloadCurrentQuoteImage(false);
    alert('حدث خطأ أثناء المشاركة. تم تنزيل الصورة بدلاً من ذلك.');
  }
});

/* cinematic toggle */
toggleCineBtn.addEventListener('click', ()=>{
  useCinematic = !useCinematic;
  vignetteEl.style.display = useCinematic ? 'block' : 'none';
  grainEl.style.display = useCinematic ? 'block' : 'none';
  cineState.textContent = 'فيلم: ' + (useCinematic ? 'مفعّل' : 'معطل');
});

/* draw canvas and return blob */
async function drawCanvasBlob(){
  const cw = 1920, ch = 1080;
  const canvas = document.createElement('canvas'); canvas.width = cw; canvas.height = ch;
  const ctx = canvas.getContext('2d');

  // draw background (cover)
  const bgUrl = backgrounds[currentIndex % backgrounds.length];
  try { await drawBackground(ctx, bgUrl, cw, ch); }
  catch(e){ // fallback gradient
    const g = ctx.createLinearGradient(0,0,cw,ch); g.addColorStop(0,'#111827'); g.addColorStop(1,'#0f172a'); ctx.fillStyle = g; ctx.fillRect(0,0,cw,ch);
  }

  // overlay dark
  ctx.fillStyle = 'rgba(0,0,0,0.36)'; ctx.fillRect(0,0,cw,ch);

  // cinematic effects on canvas if enabled
  if(useCinematic){
    // vignette
    const vg = ctx.createRadialGradient(cw/2, ch/2, Math.min(cw,ch)*0.15, cw/2, ch/2, Math.max(cw,ch));
    vg.addColorStop(0, 'rgba(0,0,0,0)');
    vg.addColorStop(1, 'rgba(0,0,0,0.6)');
    ctx.fillStyle = vg; ctx.fillRect(0,0,cw,ch);
    // grain (simple noise)
    const grainCanvas = document.createElement('canvas'); grainCanvas.width = 800; grainCanvas.height = 800;
    const gctx = grainCanvas.getContext('2d');
    const id = gctx.createImageData(grainCanvas.width, grainCanvas.height);
    for(let i=0;i<id.data.length;i+=4){
      const v = Math.random()*40; id.data[i]=id.data[i+1]=id.data[i+2]=v; id.data[i+3]=20;
    }
    gctx.putImageData(id,0,0);
    ctx.globalAlpha = 0.08;
    ctx.drawImage(grainCanvas, 0, 0, cw, ch);
    ctx.globalAlpha = 1;
  }

  // quote text
  const padding = 180;
  const maxW = cw - padding*2;
  const fontSize = parseInt(fontSizeRange.value) || 34;
  ctx.fillStyle = '#ffffff';
  ctx.textAlign = 'right';
  ctx.font = `${fontSize}px "Playfair Display", serif`;
  ctx.shadowColor = 'rgba(0,0,0,0.45)'; ctx.shadowBlur = 18; ctx.shadowOffsetY = 8;

  const q = allQuotes()[currentIndex] || {text:'', author:''};
  const lines = wrapText(ctx, q.text, maxW);
  const totalH = lines.length * (fontSize * 1.18);
  let startY = (ch - totalH) / 2;
  lines.forEach((line, idx)=> {
    const y = startY + idx * (fontSize * 1.18);
    ctx.fillText(line, cw - padding, y);
  });

  if(q.author){
    ctx.font = '22px Cairo, sans-serif';
    ctx.shadowBlur = 10;
    ctx.fillText(q.author, cw - padding, startY + lines.length*(fontSize*1.18) + 42);
  }

  return new Promise(resolve => canvas.toBlob(blob => resolve(blob), 'image/png'));
}

/* helper: draw background cover behaviour */
function drawBackground(ctx, url, w, h){
  return new Promise((resolve, reject)=>{
    const img = new Image(); img.crossOrigin = "anonymous";
    img.onload = ()=> {
      const iw = img.width, ih = img.height; const r = Math.max(w/iw, h/ih);
      const nw = iw*r, nh = ih*r; const dx = (w-nw)/2, dy = (h-nh)/2;
      ctx.drawImage(img, dx, dy, nw, nh);
      resolve();
    }
    img.onerror = ()=> reject();
    img.src = url + (url.includes('?') ? '&' : '?') + 'ix=1';
  });
}

/* wrapText for canvas (simple) */
function wrapText(ctx, text, maxWidth){
  const words = text.split(' ');
  const lines = []; let line = '';
  words.forEach(w=>{
    const test = line ? (line + ' ' + w) : w;
    const metrics = ctx.measureText(test);
    if(metrics.width > maxWidth && line){
      lines.push(line); line = w;
    } else line = test;
  });
  if(line) lines.push(line);
  return lines;
}

/* download helper */
async function downloadCurrentQuoteImage(openAfter=false){
  const blob = await drawCanvasBlob();
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url; a.download = 'aesthetic-quote.png'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 2000);
  if(openAfter) {
    alert('تم تنزيل الصورة. يمكنك مشاركتها على الشبكات الاجتماعية أو رفعها على إنستجرام.');
  }
}

/* backgrounds upload */
addBgBtn.addEventListener('click', ()=> {
  const f = bgUpload.files[0]; if(!f){ alert('اختاري ملف صورة أولاً'); return; }
  const reader = new FileReader();
  reader.onload = (e)=>{
    const dataUrl = e.target.result;
    userBackgrounds.unshift(dataUrl); // أضف بالأول
    localStorage.setItem('user_backgrounds', JSON.stringify(userBackgrounds));
    loadBackgrounds();
    setBackground(0);
    highlightThumb(0);
  };
  reader.readAsDataURL(f);
});

/* clear user backgrounds */
clearUserBgBtn.addEventListener('click', ()=>{
  if(!confirm('هل تودين حذف كل الخلفيات التي رفعتيها؟')) return;
  userBackgrounds = []; localStorage.removeItem('user_backgrounds'); loadBackgrounds(); setBackground(0);
});

/* font size live */
fontSizeRange.addEventListener('input', ()=> {
  document.getElementById('quoteText').style.fontSize = fontSizeRange.value + 'px';
});

/* cinematic initial */
vignetteEl.style.display = 'none'; grainEl.style.display = 'none';

/* init */
function init(){
  try{ const u = JSON.parse(localStorage.getItem('quotes_user') || "[]"); if(Array.isArray(u)) userQuotes = u; }catch(e){}
  try{ const ub = JSON.parse(localStorage.getItem('user_backgrounds') || "[]"); if(Array.isArray(ub) && ub.length) userBackgrounds = ub; }catch(e){}
  loadBackgrounds();
  renderDots();
  renderQuote();
  startTimer();
}

/* reset temp view (for filters) */
function resetTempView(){ renderDots(); renderQuote(); }

/* initial run */
init();

</script>
</body>
</html>